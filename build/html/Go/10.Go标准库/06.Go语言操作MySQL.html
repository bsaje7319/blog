

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>10.6. Go语言操作MySQL &mdash; 运维开发修炼之路</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10.7. Json序列化和反序列化" href="07.Json序列化和反序列化.html" />
    <link rel="prev" title="10.5. net_http包" href="05.net_http包.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> 小健_Linux-Python-Devops_Blog
          

          
            
            <img src="../../_static/python_go.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Go语言学习</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.Go语言基本语法与使用/index.html">1. Go语言基本语法与使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.容器-存储与组织数据的方式/index.html">2. 容器-存储与组织数据的方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03.流程控制/index.html">3. 流程控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04.函数/index.html">4. 函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.结构体/index.html">5. 结构体</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.接口/index.html">6. 接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.包/index.html">7. 包</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.并发/index.html">8. 并发</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Go语言基础之反射/index.html">9. Go语言基础之反射</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">10. Go标准库</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.文件IO的操作.html">10.1. 文件IO的操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="02.fmt包.html">10.2. fmt包</a></li>
<li class="toctree-l3"><a class="reference internal" href="03.Socket网络.html">10.3. Socket网络</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.模板.html">10.4. 模板</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.net_http包.html">10.5. net_http包</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">10.6. Go语言操作MySQL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">10.6.1. Go操作MySQL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="07.Json序列化和反序列化.html">10.7. Json序列化和反序列化</a></li>
<li class="toctree-l3"><a class="reference internal" href="08.Go语言常用资料及工具详细汇总.html">10.8. Go语言常用资料及工具详细汇总</a></li>
<li class="toctree-l3"><a class="reference internal" href="09.Go执行shell命令.html">10.9. Go执行shell命令</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../11.项目代码/index.html">11. 项目代码</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Python/index.html">Python自动化运维</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Go_vs_Python/index.html">Go vs Python</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-Python-Devops_Blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Go语言学习</a> &raquo;</li>
        
          <li><a href="index.html">10. Go标准库</a> &raquo;</li>
        
      <li>10.6. Go语言操作MySQL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Go/10.Go标准库/06.Go语言操作MySQL.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#gomysql" id="id12">Go语言操作MySQL</a><ul>
<li><a class="reference internal" href="#id1" id="id13">Go操作MySQL</a><ul>
<li><a class="reference internal" href="#id2" id="id14">连接</a></li>
<li><a class="reference internal" href="#id3" id="id15">下载依赖</a></li>
<li><a class="reference internal" href="#mysql" id="id16">使用MySQL驱动</a></li>
<li><a class="reference internal" href="#id4" id="id17">Mysql数据库操作</a></li>
<li><a class="reference internal" href="#id5" id="id18">插入数据</a></li>
<li><a class="reference internal" href="#id6" id="id19">删除数据</a></li>
<li><a class="reference internal" href="#id7" id="id20">修改数据</a></li>
<li><a class="reference internal" href="#id8" id="id21">查询数据</a></li>
<li><a class="reference internal" href="#id11" id="id22">事务处理</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="gomysql">
<h1><a class="toc-backref" href="#id12">10.6. Go语言操作MySQL</a><a class="headerlink" href="#gomysql" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id13">10.6.1. Go操作MySQL</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id14">连接</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Go语言中的database/sql包提供了保证SQL或类SQL数据库的泛用接口，并不提供具体的数据库驱动。</p>
<p>使用database/sql包时必须注入（至少）一个数据库驱动。</p>
<p>我们常用的数据库基本上都有完整的第三方实现。例如：MySQL驱动</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id15">下载依赖</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">go</span> <span class="n">get</span> <span class="o">-</span><span class="n">u</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">go</span><span class="o">-</span><span class="n">sql</span><span class="o">-</span><span class="n">driver</span><span class="o">/</span><span class="n">mysql</span>
</pre></div>
</div>
</div>
<div class="section" id="mysql">
<h3><a class="toc-backref" href="#id16">使用MySQL驱动</a><a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">Open</span><span class="p">(</span><span class="n">driverName</span><span class="p">,</span> <span class="n">dataSourceName</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">DB</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
<p>Open打开一个dirverName指定的数据库，dataSourceName指定数据源，一般至少包括数据库文件名和其它连接必要的信息。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;database/sql&quot;</span>

    <span class="n">_</span> <span class="s2">&quot;github.com/go-sql-driver/mysql&quot;</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">DSN</span><span class="p">:</span><span class="n">Data</span> <span class="n">Source</span> <span class="n">Name</span>
    <span class="n">dsn</span> <span class="p">:</span><span class="o">=</span> <span class="s2">&quot;user:password@tcp(127.0.0.1:3306)/dbname&quot;</span>
    <span class="n">db</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">dsn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">defer</span> <span class="n">db</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>  <span class="o">//</span> <span class="n">注意这行代码要写在上面err判断的下面</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id17">Mysql数据库操作</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>我们先建立表结构：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE TABLE t_article_cate (
`cid` int(10) NOT NULL AUTO_INCREMENT,
`cname` varchar(60) NOT NULL,
`ename` varchar(100),
`cateimg` varchar(255),
`addtime` int(10) unsigned NOT NULL DEFAULT &#39;0&#39;,
`publishtime` int(10) unsigned NOT NULL DEFAULT &#39;0&#39;,
`scope` int(10) unsigned NOT NULL DEFAULT &#39;10000&#39;,
`status` tinyint(1) unsigned NOT NULL DEFAULT &#39;0&#39;,
PRIMARY KEY (`cid`),
UNIQUE KEY catename (`cname`)) ENGINE=InnoDB AUTO_INCREMENT=99 DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;
</pre></div>
</div>
<p>下面代码使用预编译的方式，来进行增删改查的操作，并通过事务来批量提交一批数据。预编译语句
(PreparedStatement)提供了诸多好处，可以实现自定义参数的查询，通常来说，比手动拼接字符串
SQL 语句高效，可以防止SQL注入攻击。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package main

import (
    &quot;database/sql&quot;
    &quot;fmt&quot;
    _ &quot;github.com/go-sql-driver/mysql&quot;
    &quot;time&quot;
)

type DbWorker struct {
    Dsn string
    Db  *sql.DB
}

type Cate struct {
    cid     int
    cname   string
    addtime int
    scope   int
}

// 因为Go是强类型语言，所以查询数据时先定义数据类型

func main() {
    dbw := DbWorker{
        Dsn: &quot;root:admin#123@tcp(localhost:3306)/mytest?charset=utf8mb4&quot;}
    // 支持下面几种DSN写法，具体看mysql服务端配置，常见为第2种
    // user@unix(/path/to/socket)/dbname?charset=utf8
    // user:password@tcp(localhost:5555)/dbname?charset=utf8
    // user:password@/dbname
    // user:password@tcp([de:ad:be:ef::ca:fe]:80)/dbname

    dbtemp, err := sql.Open(&quot;mysql&quot;, dbw.Dsn)
    dbw.Db = dbtemp
    if err != nil {
        panic(err)
        return
    }
    //关闭数据库连接
    defer dbw.Db.Close()

    // 插入数据测试
    dbw.insertData()

    // 删除数据测试
    dbw.deleteData()

    // 修改数据测试
    dbw.editData()

    //查询数据测试
    // 单行查询
    dbw.queryRowDemo()

    // 多行查询
    dbw.queryMultiRowDemo()

    //事务操作测试
    dbw.transaction()

}
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id18">插入数据</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//插入数据，sql预编译
func (dbw *DbWorker) insertData() {
    stmt, _ := dbw.Db.Prepare(`INSERT INTO t_article_cate (cname, addtime,scope) VALUES (?, ?, ?)`)
    defer stmt.Close()
    ret, err := stmt.Exec(&quot;栏目1&quot;, time.Now().Unix(), 10)
    // 通过返回的ret可以进一步查询本次插入数据影响的行数
    // RowsAffected和最后插入的Id(如果数据库支持查询最后插入Id)
    if err != nil {
        fmt.Printf(&quot;insert data error:%v\n&quot;, err)
        return
    }
    if LastInsertId, err := ret.LastInsertId(); err == nil {
        fmt.Println(&quot;LastInsertId:&quot;, LastInsertId)
    }
    if RowsAffected, err := ret.RowsAffected(); err == nil {
        fmt.Println(&quot;RowsAffected:&quot;, RowsAffected)
    }
}
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id19">删除数据</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//删除数据
func (dbw *DbWorker) deleteData() {
    stmt, err_d := dbw.Db.Prepare(`DELETE from t_article_cate WHERE cid=?`)
    ret, err_d := stmt.Exec(99)
    // 通过返回的ret可以进一步查询本次插入数据影响的行数RowsAffected和
    // 最后插入的Id(如果数据库支持查询最后插入Id).
    if err_d != nil {
        fmt.Printf(&quot;insert data error: %v\n&quot;, err_d)
        return
    }
    if RowsAffected, err := ret.RowsAffected(); err == nil {
        fmt.Println(&quot;RowsAffected:&quot;, RowsAffected)
    }
}
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id20">修改数据</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 修改数据
func (dbw *DbWorker) editData() {
    stmt, err := dbw.Db.Prepare(`UPDATE t_article_cate SET scope=? where cid=?`)
    ret, erredit := stmt.Exec(123, 100)
    // 通过返回的ret可以进一步查询本次插入数据影响的行数RowsAffected和
    // 最后插入的Id(如果数据库支持查询最后插入Id).
    if erredit != nil {
        fmt.Printf(&quot;insert data error: %v\n&quot;, err)
        return
    }
    if RowsAffected, err := ret.RowsAffected(); err == nil {
        fmt.Println(&quot;RowsAffected: &quot;, RowsAffected)
    }
}
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id21">查询数据</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id9">
<h4>单行查询<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 单行查询
func (dbw *DbWorker) queryRowDemo() {
    sqlStr := &quot;select cname, addtime, scope from t_article_cate where cid=?&quot;
    var u Cate
    // 非常重要：确保QueryRow之后调用Scan方法，否则持有的数据库链接不会被释放
    err := dbw.Db.QueryRow(sqlStr, 100).Scan(&amp;u.cname, &amp;u.addtime, &amp;u.scope)
    if err != nil {
        fmt.Printf(&quot;scan failed, err:%v\n&quot;, err)
        return
    }
    fmt.Printf(&quot;canme:%s addtime:%d scope:%d\n&quot;, u.cname, u.addtime, u.scope)
}
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4>多行查询<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p><img alt="image0" src="../../_images/duohangchaxun01.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 多行查询
func (dbw *DbWorker) queryMultiRowDemo() {
    sqlStr := &quot;select cname, addtime, scope from t_article_cate where cid&gt;?&quot;
    rows, err := dbw.Db.Query(sqlStr, 50)
    if err != nil {
        fmt.Printf(&quot;query failed, err:%v\n&quot;, err)
        return
    }
    // 非常重要：关闭rows释放持有的数据库链接
    defer rows.Close()

    // 循环读取结果集中的数据
    for rows.Next() {
        var u Cate
        err := rows.Scan(&amp;u.cname, &amp;u.addtime, &amp;u.scope)
        if err != nil {
            fmt.Printf(&quot;scan failed, err:%v\n&quot;, err)
            return
        }
        fmt.Printf(&quot;canme:%s addtime:%d scope:%d\n&quot;, u.cname, u.addtime, u.scope)
    }
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id22">事务处理</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>db.Begin()开始事务，Commit() 或
Rollback()关闭事务。Tx从连接池中取出一个连接，在关闭
之前都使用这个连接。Tx不能和DB层的BEGIN，COMMIT混合使用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 事务处理
func (dbw *DbWorker) transaction() {
    tx, err := dbw.Db.Begin()
    if err != nil {
        fmt.Printf(&quot;insert data error: %v\n&quot;, err)
        return
    }
    defer tx.Rollback()
    stmt, err1 := tx.Prepare(`INSERT INTO t_article_cate (cname, addtime,scope) VALUES (?, ?, ?)`)
    if err1 != nil {
        fmt.Printf(&quot;insert data error: %v\n&quot;, err1)
        return
    }
    for i := 100; i &lt; 140; i++ {
        cname := strings.Join([]string{&quot;栏目-&quot;, string(i)}, &quot;-&quot;)
        _, err = stmt.Exec(cname, time.Now().Unix(), i+20)
        if err != nil{
            fmt.Printf(&quot;insert data error: %v\n&quot;,err)
            return
        }
    }
    err = tx.Commit()
    if err !=nil{
        fmt.Printf(&quot;insert data error: %v\n&quot;,err)
        return
    }
    stmt.Close()
}
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="07.Json序列化和反序列化.html" class="btn btn-neutral float-right" title="10.7. Json序列化和反序列化" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="05.net_http包.html" class="btn btn-neutral float-left" title="10.5. net_http包" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, huxiaojian

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>