

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>15.2. socket编程 &mdash; 运维开发修炼之路</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="next" title="15.3. socketserver编程" href="03.socketserver编程.html" />
    <link rel="prev" title="15.1. TCP/IP协议" href="01.python网络编程基础.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> 小健_Linux-Python-Devops_Blog
          

          
            
            <img src="../../_static/python_go.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Go/index.html">Go语言学习</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Python自动化运维</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.Python数据类型/index.html">1. Python数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.流程控制语句/index.html">2. Python中流程控制语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03.Python函数/index.html">3. Python函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04.Python内建函数/index.html">4. Python内建函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.推导式学习/index.html">5. 推导式学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.迭代器_生成器_装饰器/index.html">6. 生成器、迭代器、装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.面对对象设计_OOP/index.html">7. 面对对象设计_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.异常处理/index.html">8. 异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Python文件操作/index.html">9. Python文件操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.Python中的包和模块/index.html">10. Python中包和模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11.正则表达式/index.html">11. Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12.Python标准库/index.html">12. Python 标准库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13.Python操作数据库/index.html">13. Python对数据库的操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14.Python三方库/index.html">14. Python 三方库学习</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">15. Python 网络编程</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.python网络编程基础.html">15.1. TCP/IP协议</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">15.2. socket编程</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pythonsocket">15.2.1. Python中的socket通信逻辑如下图所示（图片来自网络）：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#socket-socket">15.2.2. socket.socket()方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">15.2.3. socket编程思路：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tcp">15.2.4. TCP编程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tcp-socket">15.2.5. TCP Socket文件上传工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#udp-socket">15.2.6. UDP Socket文件上传工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#udp">15.2.7. UDP编程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">15.2.8. socket模块创建多线程服务器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">15.2.9. 一个TCP的聊天程序</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="03.socketserver编程.html">15.3. socketserver编程</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.python收发邮件学习.html">15.4. Python发送邮件</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.python实现通用的NTP时间服务器.html">15.5. python实现通用的NTP时间服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="06.使用Python实现一个geek邮件客户端.html">15.6. 使用Python实现一个geek邮件客户端</a></li>
<li class="toctree-l3"><a class="reference internal" href="07.创建一个简单的REST接口.html">15.7. 07.创建一个简单的REST接口</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../16.线程和进程/index.html">16. Python 进程和线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../17.Python语言的扩展与嵌入/index.html">17. Python与C语言扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../20.自动化运维工具/index.html">18. 自动化运维工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../21.Python进阶学习/index.html">19. Python进阶学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../22.Python网络爬虫/index.html">20. Python网络爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../23.前端技术/index.html">21. 前端技术</a></li>
<li class="toctree-l2"><a class="reference internal" href="../24.Python框架学习/index.html">22. Python框架学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../25.Python开发环境部署/index.html">23. Python开发环境部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../26.我的第一本算法书/index.html">24. 我的第一本算法书</a></li>
<li class="toctree-l2"><a class="reference internal" href="../27.Python3网络爬虫开发实战/index.html">25. Python3网络爬虫开发实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../28.Python让繁琐的工作自动化/index.html">26. Python让繁琐的工作自动化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../29.疯狂的Python讲义/index.html">27. 疯狂的Python讲义</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Go_vs_Python/index.html">Go vs Python</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Linux-Python-Devops_Blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Python自动化运维</a> &raquo;</li>
        
          <li><a href="index.html">15. Python 网络编程</a> &raquo;</li>
        
      <li>15.2. socket编程</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Python/15.Python网络编程/02.socket编程.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#socket" id="id13">socket编程</a><ul>
<li><a class="reference internal" href="#pythonsocket" id="id14">Python中的socket通信逻辑如下图所示（图片来自网络）：</a></li>
<li><a class="reference internal" href="#socket-socket" id="id15">socket.socket()方法</a></li>
<li><a class="reference internal" href="#id1" id="id16">socket编程思路：</a></li>
<li><a class="reference internal" href="#tcp" id="id17">TCP编程</a><ul>
<li><a class="reference internal" href="#id2" id="id18">服务端</a></li>
<li><a class="reference internal" href="#id3" id="id19">一个简易的聊天系统</a></li>
<li><a class="reference internal" href="#id4" id="id20">客户端</a></li>
<li><a class="reference internal" href="#c-1-s-1" id="id21">代码示例 C-1—&gt;S-1</a></li>
<li><a class="reference internal" href="#c-2-s-2" id="id22">客户端 代码示例 2 C-2—&gt;S-2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tcp-socket" id="id23">TCP Socket文件上传工具</a></li>
<li><a class="reference internal" href="#udp-socket" id="id24">UDP Socket文件上传工具</a></li>
<li><a class="reference internal" href="#udp" id="id25">UDP编程</a><ul>
<li><a class="reference internal" href="#id5" id="id26">服务端</a></li>
<li><a class="reference internal" href="#id7" id="id27">客户端</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id28">socket模块创建多线程服务器</a><ul>
<li><a class="reference internal" href="#id10" id="id29">代码示例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id30">一个TCP的聊天程序</a><ul>
<li><a class="reference internal" href="#id12" id="id31">执行如下</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="socket">
<h1><a class="toc-backref" href="#id13">15.2. socket编程</a><a class="headerlink" href="#socket" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>socket是基于C/S架构的，也就是说进行socket网络编程，通常需要编写两个py文件，一个服务端，一个客户端。</li>
<li>导入Python中的socket模块： import socket</li>
</ul>
<div class="section" id="pythonsocket">
<h2><a class="toc-backref" href="#id14">15.2.1. Python中的socket通信逻辑如下图所示（图片来自网络）：</a><a class="headerlink" href="#pythonsocket" title="Permalink to this headline">¶</a></h2>
<p><img alt="image0" src="../../_images/network4.png" /></p>
<p>在Python中，import
socket后，用socket.socket()方法来创建套接字，语法格式如下：</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>sk = socket.socket([family[, type[, proto]]])
参数说明：
    family: 套接字家族，可以使AF_UNIX或者AF_INET。
    type: 套接字类型，根据是面向连接的还是非连接分为SOCK_STREAM或SOCK_DGRAM，也就是TCP和UDP的区别。
    protocol: 一般不填默认为0。
    直接socket.socket()，则全部使用默认值。
</pre></div>
</div>
<ul class="simple">
<li>具体的参数定义：</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>socket类型                            描述
socket.AF_UNIX              只能够用于单一的Unix系统进程间通信
socket.AF_INET              IPv4
socket.AF_INET6             IPv6
socket.SOCK_STREAM              流式socket , for TCP
socket.SOCK_DGRAM               数据报式socket , for UDP
socket.SOCK_RAW             原始套接字，普通的套接字无法处理ICMP、IGMP等网络报文，而SOCK_RAW可以；其次，SOCK_RAW也可以处理特殊的IPv4报文；此外，利用原始套接字，可以通过IP_HDRINCL套接字选项由用户构造IP头。
socket.SOCK_SEQPACKET       可靠的连续数据包服务
创建TCP Socket：               s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
创建UDP Socket：               s=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)

s = socket.socket()方法，我们可以获得一个socket对象s，也就是通常说的获取了一个“套接字”
</pre></div>
</div>
</div>
<div class="section" id="socket-socket">
<h2><a class="toc-backref" href="#id15">15.2.2. socket.socket()方法</a><a class="headerlink" href="#socket-socket" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span>方法  描述
服务器端方法
s.bind()    绑定地址（host,port）到套接字，在AF_INET下,以元组（host,port）的形式表示地址。
s.listen(backlog)   开始监听。backlog指定在拒绝连接之前，操作系统可以挂起的最大连接数量。该值至少为1，大部分应用程序设为5就可以了。
s.accept()  被动接受客户端连接,(阻塞式)等待连接的到来，并返回（conn,address）二元元组,其中conn是一个通信对象，可以用来接收和发送数据。address是连接客户端的地址。


客户端方法
s.connect(address)  客户端向服务端发起连接。一般address的格式为元组（hostname,port），如果连接出错，返回socket.error错误。
s.connect_ex()  connect()函数的扩展版本,出错时返回出错码,而不是抛出异常


公共方法
s.recv(bufsize) 接收数据，数据以bytes类型返回，bufsize指定要接收的最大数据量。
s.send()    发送数据。返回值是要发送的字节数量。
s.sendall() 完整发送数据。将数据发送到连接的套接字，但在返回之前会尝试发送所有数据。成功返回None，失败则抛出异常。
s.recvform()    接收UDP数据，与recv()类似，但返回值是（data,address）。其中data是包含接收的数据，address是发送数据的套接字地址。
s.sendto(data,address)  发送UDP数据，将数据data发送到套接字，address是形式为（ipaddr，port）的元组，指定远程地址。返回值是发送的字节数。
s.close()   关闭套接字，必须执行。
s.getpeername() 返回连接套接字的远程地址。返回值通常是元组（ipaddr,port）。
s.getsockname() 返回套接字自己的地址。通常是一个元组(ipaddr,port)
s.setsockopt(level,optname,value)   设置给定套接字选项的值。
s.getsockopt(level,optname[.buflen])    返回套接字选项的值。
s.settimeout(timeout)   设置套接字操作的超时期，timeout是一个浮点数，单位是秒。值为None表示没有超时期。一般，超时期应该在刚创建套接字时设置，因为它们可能用于连接的操作（如connect()）
s.gettimeout()  返回当前超时期的值，单位是秒，如果没有设置超时期，则返回None。
s.fileno()  返回套接字的文件描述符。
s.setblocking(flag) 如果flag为0，则将套接字设为非阻塞模式，否则将套接字设为阻塞模式（默认值）。非阻塞模式下，如果调用recv()没有发现任何数据，或send()调用无法立即发送数据，那么将引起socket.error异常。
s.makefile()    创建一个与该套接字相关连的文件
</pre></div>
</div>
<p><strong>注意事项：</strong></p>
<ul class="simple">
<li>Python3以后，socket传递的都是bytes类型的数据，字符串需要先转换一下，string.encode()即可；
另一端接收到的bytes数据想转换成字符串，只要bytes.decode()一下就可以。`</li>
<li>在正常通信时，accept()和recv()方法都是阻塞的。所谓的阻塞，指的是程序会暂停在那，一直等到有数据过来。</li>
</ul>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id16">15.2.3. socket编程思路：</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Python的socket编程，通常可分为TCP和UDP编程两种</p>
<p>TCP是带连接的可靠传输服务，每次通信都要握手，结束传输也要挥手，数据会被检验，是使用最广的通用模式；
UDP是不带连接的传输服务，简单粗暴，不加控制和检查的一股脑将数据发送出去的方式，但是传输速度快，通常用于安全和可靠等级不高的业务场景，比如文件下载。</p>
</li>
</ul>
</div>
<div class="section" id="tcp">
<h2><a class="toc-backref" href="#id17">15.2.4. TCP编程</a><a class="headerlink" href="#tcp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id18">服务端</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>创建套接字，绑定套接字到本地IP与端口：socket.socket(socket.AF_INET,socket.SOCK_STREAM) , s.bind()
开始监听连接：s.listen()
进入循环，不断接受客户端的连接请求：s.accept()
接收传来的数据，或者发送数据给对方：s.recv() , s.sendall()
传输完毕后，关闭套接字：s.close()

s = socket()        #建立套接字
s.bind()            #绑定本机地址
s.listen()          #开始监听
c,a = s.accept()    #等待连接
c.recv()            #接收数据
c.send()            #发送数据
s.close()           #关闭套接字
</pre></div>
</div>
<div class="section" id="s-1">
<h4>服务端 代码示例 S-1<a class="headerlink" href="#s-1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">10888</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client</span><span class="se">\&#39;</span><span class="s2">s Address:&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Receive Data:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="s-2">
<h4>代码示例 2 S-2<a class="headerlink" href="#s-2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip_port</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="n">sk</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>            <span class="c1"># 创建套接字</span>
<span class="n">sk</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ip_port</span><span class="p">)</span>                <span class="c1"># 绑定服务地址</span>
<span class="n">sk</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                    <span class="c1"># 监听连接请求</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;启动socket服务，等待客户端连接...&#39;</span><span class="p">)</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>     <span class="c1"># 等待连接，此处自动阻塞</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>     <span class="c1"># 一个死循环，直到客户端发送‘exit’的信号，才关闭连接</span>
    <span class="n">client_data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>      <span class="c1"># 接收信息</span>
    <span class="k">if</span> <span class="n">client_data</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>       <span class="c1"># 判断是否退出连接</span>
        <span class="n">exit</span><span class="p">(</span><span class="s2">&quot;通信结束&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;来自</span><span class="si">%s</span><span class="s2">的客户端向你发来信息：</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">client_data</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;服务器已经收到你的信息&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>    <span class="c1"># 回馈信息给客户端</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    <span class="c1"># 关闭连接</span>
</pre></div>
</div>
<p>eg</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">socket</span>               <span class="c1">#导入socket模块</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>          <span class="c1">#主机IP</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">8080</span>                     <span class="c1">#端口号</span>
<span class="n">web</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>           <span class="c1">#创建 socket 对象</span>
<span class="n">web</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>       <span class="c1">#绑定端口</span>
<span class="n">web</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>               <span class="c1">#设置最多连接数</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;服务器等待客户端连接...&#39;</span><span class="p">)</span>
<span class="c1">#开启死循环</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">conn</span><span class="p">,</span><span class="n">addr</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>    <span class="c1">#建立客户端连接</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>      <span class="c1">#获取客户端请求数据</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>             <span class="c1">#打印接收到的数据</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;HTTP/1.1 200 OK</span><span class="se">\r\n\r\n</span><span class="s1">Hello World&#39;</span><span class="p">)</span>     <span class="c1">#向客户端发送数据</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>            <span class="c1">#关闭连接</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">模拟网页访问客户端，可以使用网页访问127.0.0.1:8080</span></code></p>
</div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id19">一个简易的聊天系统</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Tcp-Server</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>  <span class="c1"># 导入socket模块</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>  <span class="c1"># 获取主机地址</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">12345</span>  <span class="c1"># 设置端口号</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>  <span class="c1"># 创建TCP/IP套接字</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>  <span class="c1"># 绑定地址（host,port）到套接字</span>
<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 设置最多连接数量</span>
<span class="n">sock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  <span class="c1"># 被动接受TCP客户端连接</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;连接已经建立&#39;</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># 接收客户端数据</span>
<span class="k">while</span> <span class="n">info</span> <span class="o">!=</span> <span class="s1">&#39;byebye&#39;</span><span class="p">:</span>  <span class="c1"># 判断是否退出</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;接收到的内容:&#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">)</span>
    <span class="n">send_data</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;输入发送内容：&#39;</span><span class="p">)</span>  <span class="c1"># 发送消息</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># 发送TCP数据</span>
    <span class="k">if</span> <span class="n">send_data</span> <span class="o">==</span> <span class="s1">&#39;byebye&#39;</span><span class="p">:</span>  <span class="c1"># 如果发送byebye,则退出</span>
        <span class="k">break</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># 接收客户端数据</span>
<span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭客户端套接字</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭服务器套接字</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Tcp-Client</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>  <span class="c1"># 导入socket模块</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>  <span class="c1"># 创建TCP/IP套接字</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>  <span class="c1"># 获取主机地址</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">12345</span>  <span class="c1"># 设置端口号</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>  <span class="c1"># 主动初始化TCP服务器连接</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;已连接&#39;</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">while</span> <span class="n">info</span> <span class="o">!=</span> <span class="s1">&#39;byebye&#39;</span><span class="p">:</span>  <span class="c1"># 判断是否退出</span>
    <span class="n">send_data</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;输入发送内容：&#39;</span><span class="p">)</span>  <span class="c1"># 输入内容</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">send_data</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># 发送TCP数据</span>
    <span class="k">if</span> <span class="n">send_data</span> <span class="o">==</span> <span class="s1">&#39;byebye&#39;</span><span class="p">:</span>  <span class="c1"># 判断是否退出</span>
        <span class="k">break</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># 接收服务器数据</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;接收到的内容:&#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭套接字</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id20">客户端</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>创建套接字，连接服务器地址：socket.socket(socket.AF_INET,socket.SOCK_STREAM) , s.connect()
连接后发送数据和接收数据：s.sendall(), s.recv()
传输完毕后，关闭套接字：s.close()

s = socket()        #建立套接字
s.connect()         #连接服务器
c.recv()            #接收数据
c.send()            #发送数据
s.close()           #关闭套接字
</pre></div>
</div>
</div>
<div class="section" id="c-1-s-1">
<h3><a class="toc-backref" href="#id21">代码示例 C-1—&gt;S-1</a><a class="headerlink" href="#c-1-s-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="n">PROST</span> <span class="o">=</span><span class="mi">10888</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="n">PROST</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;你好！&quot;</span>
<span class="k">while</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Receive from server:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;please input a info:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="c-2-s-2">
<h3><a class="toc-backref" href="#id22">客户端 代码示例 2 C-2—&gt;S-2</a><a class="headerlink" href="#c-2-s-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">ip_port</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>     <span class="c1"># 创建套接字</span>

<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ip_port</span><span class="p">)</span>      <span class="c1"># 连接服务器</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>     <span class="c1"># 通过一个死循环不断接收用户输入，并发送给服务器</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;请输入要发送的信息： &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inp</span><span class="p">:</span>     <span class="c1"># 防止输入空信息，导致异常退出</span>
        <span class="k">continue</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">inp</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>   <span class="c1"># 如果输入的是‘exit’，表示断开连接</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;结束通信！&quot;</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="n">server_reply</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">server_reply</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>       <span class="c1"># 关闭连接</span>
</pre></div>
</div>
<ul class="simple">
<li>这个过程中，一定要注意，收发是一一对应的，有发就要有收，并且recv()方法默认是阻塞的。</li>
</ul>
</div>
</div>
<div class="section" id="tcp-socket">
<h2><a class="toc-backref" href="#id23">15.2.5. TCP Socket文件上传工具</a><a class="headerlink" href="#tcp-socket" title="Permalink to this headline">¶</a></h2>
<p>Server</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/5/22 13:16</span>
<span class="c1"># filename: 文件上传工具Server.py</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8888</span>

<span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;coco2dxcplu_copy.jpg&#39;</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;服务器启动.........&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># 创建字节序列对象列表，作为接受数据的缓冲区</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="c1"># 接收的数据添加到缓冲区</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 没有接收到数据则退出</span>
                    <span class="k">break</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>        <span class="c1">#将buffer中的字节连接合并为一字节序列对象，bytes()是创建一个空的字节序列对象</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;服务器接收完成。&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Client</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/5/22 13:24</span>
<span class="c1"># filename: 文件上传工具Client.py</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">Host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8888</span>
<span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;coco2dxcplus_copy.jpg&#39;</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">Host</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;客户端上传数据完成........&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="udp-socket">
<h2><a class="toc-backref" href="#id24">15.2.6. UDP Socket文件上传工具</a><a class="headerlink" href="#udp-socket" title="Permalink to this headline">¶</a></h2>
<p>Server</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/5/22 13:39</span>
<span class="c1"># filename: UDP文件上传下载Server.py</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8888</span>

<span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;test_copy.txt&#39;</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;服务器启动.........&quot;</span><span class="p">)</span>

    <span class="c1"># 创建字节序列对象列表，作为接受数据的缓冲区</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>         <span class="c1">#反复接收数据</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># 接收的数据添加到缓冲区</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;bye&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#没有接收到数据，进入下次循环继续接收</span>
                <span class="k">continue</span>

            <span class="c1"># 将buffer中的字节连接合并为一字节序列对象，bytes()是创建一个空的字节序列对象</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;服务器接收完成。&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Client</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/5/22 13:44</span>
<span class="c1"># filename: UDP文件上传下载Client.py</span>


<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">Host</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8888</span>
<span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;test.txt&#39;</span>

<span class="c1">#服务器地址</span>
<span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">Host</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1">#发送数据</span>
                <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">server_address</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;bye&#39;</span><span class="p">,</span> <span class="n">server_address</span><span class="p">)</span>

                <span class="c1">#文件中没有可读取的数据则退出</span>
                <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;客户端上传数据完成......&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="udp">
<h2><a class="toc-backref" href="#id25">15.2.7. UDP编程</a><a class="headerlink" href="#udp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<span id="id6"></span><h3><a class="toc-backref" href="#id26">服务端</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">s = socket()        #建立套接字</span>
<span class="sd">s.bind()            #绑定本机地址</span>
<span class="sd">s.recvfrom()        #接收数据</span>
<span class="sd">s.sendto()          #发送数据</span>
<span class="sd">s.close()           #关闭套接字</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">10888</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">while</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">data</span><span class="p">,</span><span class="n">address</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">==</span><span class="n">b</span><span class="s1">&#39;bye&#39;</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Received String:&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">address</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<span id="id8"></span><h3><a class="toc-backref" href="#id27">客户端</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">s = socket()    # 建立套接字</span>
<span class="sd">s.recvfrom()    #接收数据</span>
<span class="sd">s.sendto()      #发送数据</span>
<span class="sd">s.close()       #关闭套接字</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">PROT</span> <span class="o">=</span> <span class="mi">10888</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;你好！&quot;</span>
<span class="k">while</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),(</span><span class="n">HOST</span><span class="p">,</span><span class="n">PROT</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;bye&quot;</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">data</span><span class="p">,</span><span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Receive from server:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;please input a info:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id28">15.2.8. socket模块创建多线程服务器</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id29">代码示例</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>        <span class="c1"># 导入线程模块</span>


<span class="k">def</span> <span class="nf">link_handler</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    该函数为线程需要执行的函数，负责具体的服务器和客户端之间的通信工作</span>
<span class="sd">    :param link: 当前线程处理的连接</span>
<span class="sd">    :param client: 客户端ip和端口信息，一个二元元组</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;服务器开始接收来自[</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]的请求....&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">client</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>     <span class="c1"># 利用一个死循环，保持和客户端的通信状态</span>
        <span class="n">client_data</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">client_data</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;结束与[</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]的通信...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">client</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">break</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;来自[</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">]的客户端向你发来信息：</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">client</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">client_data</span><span class="p">))</span>
        <span class="n">link</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;服务器已经收到你的信息&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">link</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">ip_port</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
<span class="n">sk</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>            <span class="c1"># 创建套接字</span>
<span class="n">sk</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ip_port</span><span class="p">)</span>                <span class="c1"># 绑定服务地址</span>
<span class="n">sk</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                    <span class="c1"># 监听连接请求</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;启动socket服务，等待客户端连接...&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>     <span class="c1"># 一个死循环，不断的接受客户端发来的连接请求</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  <span class="c1"># 等待连接，此处自动阻塞</span>
    <span class="c1"># 每当有新的连接过来，自动创建一个新的线程，</span>
    <span class="c1"># 并将连接对象和访问者的ip信息作为参数传递给线程的执行函数</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">link_handler</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>客户端代码保持不变</p>
<ul class="simple">
<li>启动这个多线程服务器，然后多运行几个客户端，可以很明显地看到，服务器能够同时与多个客户端通信，基本达到我们的目的。</li>
</ul>
</div>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id30">15.2.9. 一个TCP的聊天程序</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">tcp_server.py</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/9/6 11:35</span>
<span class="c1"># filename: tcp_server.py</span>
<span class="kn">import</span> <span class="nn">tkinter</span>
<span class="kn">import</span> <span class="nn">tkinter.font</span> <span class="k">as</span> <span class="nn">tkFont</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">ServerUI</span><span class="p">():</span>
    <span class="n">local</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">5505</span>
    <span class="k">global</span> <span class="n">serverSock</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        初始类相关属性的构造函数</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Python在线聊天-服务器V1.0&#39;</span><span class="p">)</span>
        <span class="c1"># 窗口面板，用4个frame面板布局</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">()]</span>
        <span class="c1"># 显示消息Text右边的滚动条</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># 显示消息Text，并绑定上面的滚动条</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">tkFont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Fixdsys&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Listbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">ft</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="p">[</span><span class="s1">&#39;yscrollcommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="o">.</span><span class="n">set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">yview</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

        <span class="c1"># 输入消息Text的滚动条</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># 输入消息Text，并与滚动条绑定</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">tkFont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Fixdsys&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">ft</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="p">[</span><span class="s1">&#39;yscrollcommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="o">.</span><span class="n">set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">yview</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

        <span class="c1"># “发送”按钮</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendButton</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;发送&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendButton</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span> <span class="ow">and</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># “关闭”按钮</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeButton</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;关闭&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeButton</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receiveMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        接收消息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 建立Socket连接</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s2">&quot;服务器已经就绪............&quot;</span><span class="p">)</span>

        <span class="c1"># 循环接受客户端的连接请求</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># 接收客户端发送的消息</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器已经与客户端建立连接.......&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器与客户端建立连接失败...........&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;客户端&#39;</span> <span class="o">+</span> <span class="n">theTime</span> <span class="o">+</span> <span class="s1">&#39;说：</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        发送消息</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># 得到用户在Text中输入的消息</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
        <span class="c1"># 格式化当前的时间</span>
        <span class="n">theTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器&#39;</span> <span class="o">+</span> <span class="n">theTime</span> <span class="o">+</span> <span class="s2">&quot;说：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># 将消息发送到客户端</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Socket连接没有建立，提示用户</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;您还未与客户端建立连接，客户端无法收到您的消息</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># 清空用户在Text中输入的消息</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        关闭消息窗口并退出</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">startNewThread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        启动一个新线程来接收客户端的消息</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">receiveMessage</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ServerUI</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">startNewThread</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">tcp_client.py</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2019/9/6 11:35</span>
<span class="c1"># filename: tcp_server.py</span>
<span class="kn">import</span> <span class="nn">tkinter</span>
<span class="kn">import</span> <span class="nn">tkinter.font</span> <span class="k">as</span> <span class="nn">tkFont</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">class</span> <span class="nc">ServerUI</span><span class="p">():</span>
    <span class="n">local</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">5505</span>
    <span class="k">global</span> <span class="n">serverSock</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        初始类相关属性的构造函数</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Python在线聊天-服务器V1.0&#39;</span><span class="p">)</span>
        <span class="c1"># 窗口面板，用4个frame面板布局</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">(),</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Frame</span><span class="p">()]</span>
        <span class="c1"># 显示消息Text右边的滚动条</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># 显示消息Text，并绑定上面的滚动条</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">tkFont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Fixdsys&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Listbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">ft</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="p">[</span><span class="s1">&#39;yscrollcommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="o">.</span><span class="n">set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatTextScrollBar</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">yview</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

        <span class="c1"># 输入消息Text的滚动条</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># 输入消息Text，并与滚动条绑定</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">tkFont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Fixdsys&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">ft</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="p">[</span><span class="s1">&#39;yscrollcommand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="o">.</span><span class="n">set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputTextScrollBar</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">yview</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

        <span class="c1"># “发送”按钮</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendButton</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;发送&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendButton</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span> <span class="ow">and</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># “关闭”按钮</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeButton</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;关闭&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeButton</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">tkinter</span><span class="o">.</span><span class="n">BOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receiveMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        接收消息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 建立Socket连接</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s2">&quot;服务器已经就绪............&quot;</span><span class="p">)</span>

        <span class="c1"># 循环接受客户端的连接请求</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># 接收客户端发送的消息</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器已经与客户端建立连接.......&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器与客户端建立连接失败...........&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;客户端&#39;</span> <span class="o">+</span> <span class="n">theTime</span> <span class="o">+</span> <span class="s1">&#39;说：</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cientMsg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        发送消息</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># 得到用户在Text中输入的消息</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
        <span class="c1"># 格式化当前的时间</span>
        <span class="n">theTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;服务器&#39;</span> <span class="o">+</span> <span class="n">theTime</span> <span class="o">+</span> <span class="s2">&quot;说：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># 将消息发送到客户端</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Socket连接没有建立，提示用户</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chatText</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="s1">&#39;您还未与客户端建立连接，客户端无法收到您的消息</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># 清空用户在Text中输入的消息</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputText</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">__len__</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        关闭消息窗口并退出</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">startNewThread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        启动一个新线程来接收客户端的消息</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">receiveMessage</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ServerUI</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">startNewThread</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id31">执行如下</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p><img alt="image1" src="../../_images/TCP_demo001.png" /></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="03.socketserver编程.html" class="btn btn-neutral float-right" title="15.3. socketserver编程" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="01.python网络编程基础.html" class="btn btn-neutral float-left" title="15.1. TCP/IP协议" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, huxiaojian

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>