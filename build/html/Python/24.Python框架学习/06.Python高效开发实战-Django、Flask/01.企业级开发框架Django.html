

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>22.6.1. 企业级开发框架Django &mdash; 运维开发修炼之路</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="22.6.2. 客户端的编程技术" href="01.客户端的编程技术.html" />
    <link rel="prev" title="22.6. Python高效开发实战-Django、Flask" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> 小健_Linux-Python-Devops_Blog
          

          
            
            <img src="../../../_static/python_go.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Go/index.html">Go语言学习</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Python自动化运维</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../01.Python数据类型/index.html">1. Python数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../02.流程控制语句/index.html">2. Python中流程控制语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../03.Python函数/index.html">3. Python函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../04.Python内建函数/index.html">4. Python内建函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../05.推导式学习/index.html">5. 推导式学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../06.迭代器_生成器_装饰器/index.html">6. 生成器、迭代器、装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../07.面对对象设计_OOP/index.html">7. 面对对象设计_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../08.异常处理/index.html">8. 异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../09.Python文件操作/index.html">9. Python文件操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../10.Python中的包和模块/index.html">10. Python中包和模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../11.正则表达式/index.html">11. Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../12.Python标准库/index.html">12. Python 标准库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../13.Python操作数据库/index.html">13. Python对数据库的操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../14.Python三方库/index.html">14. Python 三方库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../15.Python网络编程/index.html">15. Python 网络编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../16.线程和进程/index.html">16. Python 进程和线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../17.Python语言的扩展与嵌入/index.html">17. Python与C语言扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../20.Python自动化运维最佳实践/index.html">18. Python自动化运维最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../21.Python进阶学习/index.html">19. Python进阶学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../22.Python网络爬虫/index.html">20. Python网络爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../23.前端技术/index.html">21. 前端技术</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">22. Python框架学习</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../01.常用的GUI框架/index.html">22.1. 常用的GUI框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="../02.Flask-Web框架及其应用/index.html">22.2. Flask-Web框架及其应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03.Scrapy爬虫框架/index.html">22.3. Scrapy爬虫框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="../04.Django学习/index.html">22.4. Django学习</a></li>
<li class="toctree-l3"><a class="reference internal" href="../05.Tornado-Web框架及其应用/index.html">22.5. Tornado-Web框架及其应用</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">22.6. Python高效开发实战-Django、Flask</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">22.6.1. 企业级开发框架Django</a></li>
<li class="toctree-l4"><a class="reference internal" href="01.客户端的编程技术.html">22.6.2. 客户端的编程技术</a></li>
<li class="toctree-l4"><a class="reference internal" href="001.关系数据库建模.html">22.6.3. 关系数据库建模</a></li>
<li class="toctree-l4"><a class="reference internal" href="002.Linux+Nginx+uWSGI配置.html">22.6.4. Linux+Nginx+uWSGI配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="003.建立安全的HTTPS网站.html">22.6.5. 建立安全的HTTPS网站</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../25.Python开发环境部署/index.html">23. Python开发环境部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../26.我的第一本算法书/index.html">24. 我的第一本算法书</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../27.Python3网络爬虫开发实战/index.html">25. Python3网络爬虫开发实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../28.Python让繁琐的工作自动化/index.html">26. Python让繁琐的工作自动化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../29.疯狂的Python讲义/index.html">27. 疯狂的Python讲义</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../Go_vs_Python/index.html">Go vs Python</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">小健_Linux-Python-Devops_Blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Python自动化运维</a> &raquo;</li>
        
          <li><a href="../index.html">22. Python框架学习</a> &raquo;</li>
        
          <li><a href="index.html">22.6. Python高效开发实战-Django、Flask</a> &raquo;</li>
        
      <li>22.6.1. 企业级开发框架Django</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/Python/24.Python框架学习/06.Python高效开发实战-Django、Flask/01.企业级开发框架Django.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#django" id="id10">企业级开发框架Django</a><ul>
<li><a class="reference internal" href="#django2" id="id11">1.安装Django2</a></li>
<li><a class="reference internal" href="#id1" id="id12">2.实战演练：开发Django站点</a><ul>
<li><a class="reference internal" href="#id2" id="id13">2.1 建立项目</a></li>
<li><a class="reference internal" href="#id3" id="id14">2.2 建立应用</a></li>
<li><a class="reference internal" href="#id4" id="id15">2.3 基本视图</a></li>
<li><a class="reference internal" href="#web" id="id16">2.4 内置Web服务器</a></li>
<li><a class="reference internal" href="#id5" id="id17">2.5 模型类</a></li>
<li><a class="reference internal" href="#id6" id="id18">2.6 表单视图</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7" id="id19">3.使用管理界面</a></li>
<li><a class="reference internal" href="#id8" id="id20">4. Django模型层</a><ul>
<li><a class="reference internal" href="#id9" id="id21">4.1 基本操作</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="django">
<h1><a class="toc-backref" href="#id10">22.6.1. 企业级开发框架Django</a><a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h1>
<div class="section" id="django2">
<h2><a class="toc-backref" href="#id11">1.安装Django2</a><a class="headerlink" href="#django2" title="Permalink to this headline">¶</a></h2>
<p>在安装pip工具的Python环境后，可以直接通过pip install命令安装Django：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install django</span>
<span class="n">或者</span>
<span class="c1">#pip install django==2.0.7 -i &quot;https://pypi.doubanio.com/simple/&quot;       # 使用国内豆瓣pip安装django2.0.7</span>
</pre></div>
</div>
<p>该命令将自动下载Django安装包并安装。安装完成后可以进入Python，通过如下命令验证是否安装成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#python</span>
<span class="o">&gt;&gt;&gt;</span><span class="kn">import</span> <span class="nn">django</span>
<span class="o">&gt;&gt;&gt;</span><span class="nb">print</span> <span class="n">django</span><span class="o">.</span><span class="n">VERSION</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>本阶段学习使用python3和Django2.0.7</p>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id12">2.实战演练：开发Django站点</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>用Django开发网站需要遵循Django的一套开发流程。本节通过建立一个消息录入页面演示Django的开发流程及相关技术。</p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id13">2.1 建立项目</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>在进行Django开发之前需要先用django-admin建立Django项目，语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#django-admin startproject 站点名称</span>
</pre></div>
</div>
<p>其中django-admin是安装好Django组件后在Python目录中生成的Django项目管理工具。比如，建立一个叫作djangosite的开发项目，命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#django-admin startproject mydjango</span>
</pre></div>
</div>
<p>该命令在当前目录中建立了一个子目录djangosite，并在其中生成了Django开发的默认文件，djangosite的目录内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mydjango</span><span class="o">/</span>
  <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
  <span class="n">mydjango</span><span class="o">/</span>
      <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
      <span class="n">settings</span><span class="o">.</span><span class="n">py</span>
      <span class="n">urls</span><span class="o">.</span><span class="n">py</span>
      <span class="n">wsgi</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>默认生成的几个文件都非常重要，在今后的开发中要一直使用或者维护它们，对它们的意义解释如下。</p>
<p>●
manage.py：是Django用于管理本项目的命令行工具，之后进行站点运行、数据库自动生成、静态文件收集等都要通过该文件完成。</p>
<p>●
内层djangosite/目录中包含了本项目的实际文件，同时因为其中包含__init__.py文件，所以该目录也是一个Python包。</p>
<p>●
djangosite/<strong>init</strong>.py：告诉Python该目录是一个Python包，其中暂无内容。</p>
<p>● djangosite/settings.py:Django
的项目配置文件。默认时，在其中定义了本项目引用的Django 组件、Django
项目名等。在之后的开发中，还需在其中配置数据库参数、导入的其他Python包等信息。</p>
<p>●
djangosite/urls.py：维护项目的URL路由映射，即定义客户端访问的URL由哪一个Python模块解释并提供反馈。在默认情况下，其中只定义了“/admin”即管理员站点的解释器。</p>
<p>●
djangosite/wsgi.py：定义WSGI的接口信息，用于与其他Web服务器集成，一般本文件在生成后无须改动。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id14">2.2 建立应用</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id15">2.3 基本视图</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>在完成Django项目和应用的建立后，即可开始编写网站的应用代码，这里通过为注册页面显示一个欢迎标题，来演示Django的路由映射功能。</p>
<p>（1）首先在djangosite/app/views.py中建立一个路由响应函数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;h1&gt;Welcome to my tiny twitter! &lt;/h1&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>该代码定义了一个函数welcome（），简单地返回一条被HttpResponse（）封装的Welcome信息。</p>
<p>（2）接下来，要通过URL映射将用户的HTTP访问与该函数绑定起来。</p>
<p>在djangosite/app/目录中新建一个urls.py文件，管理应用app中的所有URL映射，其文件内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="k">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">welcome</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>在其中的第1行引入了django.conf.urls中的url（）函数，Django中的所有路由映射由该函数生成。第2行代码引入了djangosite/app/views.py模块。之后定义了关键变量urlpatterns，该变量是一个列表，保存所有由url（）函数生成的路由映射。本代码中只设置了一个映射，以及把所有路由映射到view.py中的welcome函数。</p>
<p>（3）在项目URL文件djangosite/urls.py的urlpatterns中增加一项，声明对应用app中urls.py文件的引用，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="k">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="k">import</span> <span class="n">include</span>                        <span class="c1">#本行新增</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^app/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;app.urls&#39;</span><span class="p">)),</span>                      <span class="c1">#本行新增</span>
  <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>首先通过import语句引入django.conf.urls.include()函数，之后在urlpatterns列表中增加一个路径app/，将其转接到app.urls包，即djangosite/app/urls.py文件。这样，通过include()函数就将两个urlpatterns连接了起来。</p>
<p><strong>注意：</strong>
url（）函数的第1个参数用正则表达式来表达URL路由，本例中^app/的含义是所有以app开头的路由。</p>
</div>
<div class="section" id="web">
<h3><a class="toc-backref" href="#id16">2.4 内置Web服务器</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h3>
<p>通过以上配置和编码过程，读者应该已经迫不及待地想检验一下网站效果了。查看网站效果首先需要通过manage.py启动Web服务器，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cd djangosite</span>
<span class="c1">#python manage.py runserver 0.0.0.0:8001</span>

<span class="n">Performing</span> <span class="n">system</span> <span class="n">checks</span><span class="o">...</span>
<span class="n">System</span> <span class="n">check</span> <span class="n">identified</span> <span class="n">no</span> <span class="n">issues</span> <span class="p">(</span><span class="mi">0</span> <span class="n">silenced</span><span class="p">)</span><span class="o">.</span>
<span class="n">February</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">2016</span> <span class="o">-</span> <span class="mi">07</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">07</span>
<span class="n">Django</span> <span class="n">version</span> <span class="mf">1.9</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span> <span class="n">settings</span> <span class="s1">&#39;djangosite.settings&#39;</span>
<span class="n">Starting</span> <span class="n">development</span> <span class="n">server</span> <span class="n">at</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8001</span><span class="o">/</span>
<span class="n">Quit</span> <span class="n">the</span> <span class="n">server</span> <span class="k">with</span> <span class="n">CONTROL</span><span class="o">-</span><span class="n">C</span><span class="o">.</span>
</pre></div>
</div>
<p>其中runserver是启动网站的关键字，后面的参数指定网站绑定的IP地址与端口号。用0.0.0.0表示绑定本机的所有IP。在命令运行的过程中将一直占用控制台，可以输入Ctrl+C组合键退出运行。</p>
<p><strong>注意：</strong> 用这种方式启动的Web 服务器是Django 内置的Web
服务器，由于性能原因，一般只可用于开发人员测试。正式运行的网站应该使用本章后面介绍的WSGI方式启动。</p>
<p>启动Web服务器后即可通过浏览器访问http://xx.xx.xx.xx/app/检验欢迎消息，效果如图6.1所示。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id17">2.5 模型类</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>现在开始Model层的处理，即设计和开发信息发布的数据访问层。本节只设计一个简单的模型，以带领读者掌握设计模型的3个步骤。</p>
<p><strong>1．配置项目INSTALLED_APPS</strong></p>
<p>要在djangosite项目的settings.py中告诉Django需要安装应用app中的模型，则方法是打开djangosite/settings.py文件，找到其中的INSTALLED_APPS数组，在其中添加应用app的Config类，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;app.apps.AppConfig&#39;</span><span class="p">,</span>                       <span class="c1">#此行新增</span>
  <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
  <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
  <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
  <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
  <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
  <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>上述代码中的app.apps.AppConfig声明的是djangosite/app/apps.py中自动生成的AppConfig类。</p>
<p><strong>2．模型定义</strong></p>
<p>打开djangosite/app/models.py，在其中新建一个模型类Moment用来定义信息发布表，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Moment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
  <span class="n">user_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
  <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>在第1行中引入了django.db.models类，所有Django模型类必须继承自它。之后定义了该类的子类Moment，在其中定义了两个字段：字符串类型的content用来保存消息的内容、发布人的名字、消息的类型。</p>
<p><strong>3．生成数据移植文件</strong></p>
<p>Django的术语“生成数据移植文件”（makemigrations）是指将models.py中定义的数据表转换成数据库生成脚本的过程。该过程通过命令行工具manage.py完成，具体的命令及输出如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cd djangosite</span>
<span class="c1">#python manage.py makemigrations app</span>
<span class="n">Migrations</span> <span class="k">for</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span>
  <span class="mi">0001</span><span class="n">_initial</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">Create</span> <span class="n">model</span> <span class="n">Moment</span>
</pre></div>
</div>
<p>通过输出可以看到完成了模型Moment的建立。输出中的0001_initial.py是数据库生成的中间文件，通过它也可以知道当前的数据库版本；该文件及以后的所有migration文件都存在于目录djangosite/app/migrations/中。</p>
<p>在makemigrations的过程中，Django会对比models.py中的模型与已有数据库之间的差异，如果没有差异则不会做任何工作，比如再次执行makemigrations操作时将产生如下输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#python manage.py makemigrations app</span>
<span class="n">No</span> <span class="n">changes</span> <span class="n">detected</span> <span class="ow">in</span> <span class="n">app</span> <span class="s1">&#39;app&#39;</span>
</pre></div>
</div>
<p>如果对models.py做任何修改，则在下一次makemigrations的时候将会将修改的内容同步到数据库中。比如，将Moment类的content字段长度从200修改为300后，再次执行makemigrations的结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#python manage.py makemigrations app</span>
<span class="n">Migrations</span> <span class="k">for</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span>
  <span class="mi">0002</span><span class="n">_auto_20160223_0633</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
<span class="o">-</span> <span class="n">Alter</span> <span class="n">field</span> <span class="n">content</span> <span class="n">on</span> <span class="n">moment</span>
</pre></div>
</div>
<p>在其过程中产生了新的中间文件0002_auto_20160223_0633.py，读者如果对其感兴趣，则可以打开该文件查看其内容，代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -＊- coding: utf-8 -＊-</span>
<span class="c1"># Generated by Django 1.9.1 on 2016-02-23 06:33</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

<span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;0001_initial&#39;</span><span class="p">),</span>
  <span class="p">]</span>

<span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">migrations</span><span class="o">.</span><span class="n">AlterField</span><span class="p">(</span>
      <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span>
      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;content&#39;</span><span class="p">,</span>
      <span class="n">field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
    <span class="p">),</span>
  <span class="p">]</span>
</pre></div>
</div>
<p>其中定义了Migration类，通过其中的dependencies指定前置版本，通过operations声明对数据库进行的修改。</p>
<p><strong>注意：</strong>
djangosite/app/migrations目录中的全部文件都由manage.py自己维护，开发者不要手动修改其中文件的内容。</p>
<p><strong>4．移植到数据库</strong></p>
<p>在模型的修改过程中可以随时调用makemigrations生成中间移植文件。而当需要使移植文件生效、修改真实的数据库schema时，则需要通过manage.py的migrate命令使修改同步到数据库中。比如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cd djangosite</span>
<span class="c1">#python manage.py migrate</span>
<span class="n">Operations</span> <span class="n">to</span> <span class="n">perform</span><span class="p">:</span>
  <span class="n">Apply</span> <span class="nb">all</span> <span class="n">migrations</span><span class="p">:</span> <span class="n">admin</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">contenttypes</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">sessions</span>
<span class="n">Running</span> <span class="n">migrations</span><span class="p">:</span>
  <span class="n">Rendering</span> <span class="n">model</span> <span class="n">states</span><span class="o">...</span> <span class="n">DONE</span>
  <span class="n">Applying</span> <span class="n">contenttypes</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">admin</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">admin</span><span class="o">.</span><span class="mi">0002</span><span class="n">_logentry_remove_auto_add</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">app</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">app</span><span class="o">.</span><span class="mi">0002</span><span class="n">_auto_20160223_0633</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">app</span><span class="o">.</span><span class="mi">0003</span><span class="n">_auto_20160224_0447</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">app</span><span class="o">.</span><span class="mi">0004</span><span class="n">_remove_moment_pub_date</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">contenttypes</span><span class="o">.</span><span class="mi">0002</span><span class="n">_remove_content_type_name</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0002</span><span class="n">_alter_permission_name_max_length</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0003</span><span class="n">_alter_user_email_max_length</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0004</span><span class="n">_alter_user_username_opts</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0005</span><span class="n">_alter_user_last_login_null</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0006</span><span class="n">_require_contenttypes_0002</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0007</span><span class="n">_alter_validators_add_error_messages</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">sessions</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
</pre></div>
</div>
<p>在命令执行的过程中将检查djangosite/app/migrations目录中的所有文件，逐步使历次生成的移植文件生效。</p>
<p><strong>技巧：</strong>
可以在每次修改models.py文件内容后运行makemigrations命令，检查改动是否符合数据库的语法规则；在调试运行之前，运行一次migrate命令使改动生效。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id18">2.6 表单视图</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>接下来的任务是设计和开发信息录入页面。该页面的基本功能为：提供输入界面，让用户输入名字、文本消息内容、选择消息类型，用户提交后网页自动设置该信息的时间并保存到数据库中。下面逐步进行开发。</p>
<p><strong>1．定义表单类</strong></p>
<p>建立表单类文件djangosite/app/forms.py，在其中定义表单类MomentForm。代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.forms</span> <span class="k">import</span> <span class="n">ModelForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="k">import</span> <span class="n">Moment</span>

<span class="k">class</span> <span class="nc">MomentForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">Moment</span>
      <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>               <span class="c1">#导入所有字段</span>
</pre></div>
</div>
<p>解析如下。</p>
<p>● 引入django.forms.ModelForm类，该类是所用Django表单类的基类。</p>
<p>●
引入在本应用models.py中定义的Moment类，以便在后面的表单类中关联Moment类。</p>
<p>●
定义表单类MomentForm，在其中定义子类Meta。在Meta中声明与本表单关联的模型类及其字段。</p>
<p>● Fields
字段可以设为__all__，也可以用列表形式声明所要导入的属性，比如：fields=（’content’,
‘user_name’, ‘kind’）。</p>
<p><strong>技巧：</strong> Meta中的fields =
‘<strong>all</strong>’将所有模型类中的字段导入表单类中。</p>
<p><strong>2．修改模型类</strong></p>
<p>为了使用户能够以单选的方式设置消息类型，则需要在models.py文件中定义单选枚举值，并与模型类Moment相关联。修改djangosite/app/models.py如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>

<span class="c1"># 新增元组用于设置消息类型枚举项</span>
<span class="n">KIND_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;Python技术&#39;</span><span class="p">,</span> <span class="s1">&#39;Python技术&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;数据库技术&#39;</span><span class="p">,</span> <span class="s1">&#39;数据库技术&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;经济学&#39;</span><span class="p">,</span> <span class="s1">&#39;经济学&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;文体资讯&#39;</span><span class="p">,</span> <span class="s1">&#39;文体资讯&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;个人心情&#39;</span><span class="p">,</span> <span class="s1">&#39;个人心情&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;其他&#39;</span><span class="p">,</span> <span class="s1">&#39;其他&#39;</span><span class="p">),</span>
<span class="p">)</span>


<span class="c1"># Create your models here.</span>


<span class="k">class</span> <span class="nc">Moment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;匿名&#39;</span><span class="p">)</span>
    <span class="c1"># 修改kind定义，加入choices参数</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">KIND_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">KIND_CHOICES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="n">LEVELS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;Very good&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;Good&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;Bad&#39;</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s2">&quot;请为本条信息评级&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">LEVELS</span><span class="p">)</span>
</pre></div>
</div>
<p>代码解析如下。</p>
<p>● 为kind字段增加了消息类型枚举项。</p>
<p>● 为user_name和kind字段用default属性增加了默认值。</p>
<p>● 因为在文件中增加了中文信息，所以要在第1行用# -<em>- coding: utf-8
-</em>-声明文件用utf-8编码。</p>
<p><strong>注意：</strong>
因为本次编辑导致模型层发生变化，所以需要用manage.py命令行工具运行makemigrations和migrate命令来更新数据库的定义。</p>
<p><strong>3．开发模板文件</strong></p>
<p>模板是Python
Web框架中用于产生HTML、XML等文本格式文档的术语。模板文件本身也是一种文本文件，开发者需要手工对其编辑和开发。建立目录djangosite/app/templates，在其中新建模板文件moments_input.html，文件的内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;! DOCTYPE html&gt;
&lt;/html&gt;
  &lt;head&gt;
      &lt;title&gt;消息录入页面&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
      &lt;form action=&quot;? &quot; method=&quot;post&quot;&gt;
        &lt;fieldset&gt;
            &lt;legend&gt;请输入并提交&lt;/legend&gt;
                {{ form.as_p }}
                &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;
        &lt;/fieldset&gt;
      &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>模板文件以HTML格式为基本结构，其中的模板内容用大括号标识。本例用{{
form.as_p
}}定义表单类MomentForm的输入字段。模板文件的详细语法将在后续章节中介绍。</p>
<p><strong>4．开发视图</strong></p>
<p>下面开发视图函数，使得表单类和页面模板衔接起来。打开djangosite/app/views.py文件，在其中加入如下函数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="k">import</span> <span class="n">MomentForm</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span>


<span class="c1"># Create your views here.</span>

<span class="k">def</span> <span class="nf">welcome</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;h1&gt;Wellcome to my django!!!&lt;/h1&gt;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">moments_input</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">MomentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">moment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">moment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;first-url&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">MomentForm</span><span class="p">()</span>
    <span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s1">&#39;app/templates&#39;</span><span class="p">,</span> <span class="s1">&#39;moments_input.html&#39;</span><span class="p">),</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
</pre></div>
</div>
<p>在代码中新增了视图函数moments_input（），该函数定义了两种访问方式的不同处理。</p>
<p>● 如果是用户的Post表单提交，则保存moment对象，并重定向到欢迎页面。</p>
<p>● 如果是普通的访问，则返回moments_input.html模板的渲染结果作为HTTP
Response。注意render()的第3个参数，将form作为参数传给了模板，这样在模板文件中才能访问该MomentForm的实例。</p>
<p>在djangosite/app/urls.py文件中增加该视图函数的路由映射，内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;moments_input&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">moments_input</span><span class="p">),</span>   <span class="c1">#本行新增</span>
  <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">welcome</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>在代码中定义了该视图的调用函数地址是moments_input，算上Django应用本身的路径，则该视图的全路径为http://xx.xx.xx.xx/app/moments_input。</p>
<div class="figure">
<img alt="" src="../../../_images/django000041.png" />
</div>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id19">3.使用管理界面</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Django管理界面是一个通过简单的配置就可以实现的数据模型后台的Web控制台。管理界面通常是给系统管理员使用的，以完成元数据的输入、删除、查询等工作。</p>
<p>首先将管理界面需要管理的模型类添加到djangosite/app/admin.py文件中，具体如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Moment</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Moment</span><span class="p">)</span>
</pre></div>
</div>
<p>本文件中只要通过admin.site.register()函数逐个声明要管理的模型类即可。</p>
<p>在第1次访问管理界面之前，需要通过manage.py工具的createsuperuser命令建立管理员用户。在命令运行的过程中按照提示输入管理员的用户名、邮箱地址、密码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#cd djangosite
#python manage.py createsuperuser
Username: admin
Email address: admin@mysite.com
Password: ＊＊＊＊＊＊＊＊＊＊
Password (again): ＊＊＊＊＊＊＊＊＊
Superuser created successfully.
</pre></div>
</div>
<p>之后即可访问管理员页面http://xx.xx.xx.xx/admin。输入用户名及密码后，效果如图6.3所示。在管理员界面提供新增Moment模型类的Add链接，单击Moments链接后，还可以看到修改和删除选项。界面中的Groups和Users涉及Django的用户管理系统，</p>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id20">4. Django模型层</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id21">4.1 基本操作</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>使用Django模型开发的首要任务就是定义模型类即其属性。每个模型类都可以被映射为数据库中的一个数据表，而类属性被映射为数据字段，除此之外，数据库表的主键、外键、约束等也通过类属性完成定义。</p>
<p><strong>1．模型类定义</strong></p>
<p>模型定义的基本结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>from django.db import models

class ModelName(models.Model):
  field1 = models.XXField(…)
  field2 = models.XXField(…)
    …
  class Meta:
      db_table = …
      other_metas = …
</pre></div>
</div>
<p>解析如下。</p>
<p>● 所有Django模型继承自django.db.models.Model类。</p>
<p>● 通过其中的类属性定义模型字段，模型字段必须是某种models.XXField类型。</p>
<p>●
通过模型类中的Meta子类定义模型元数据，比如数据库表名、数据默认排序方式等。</p>
<p>Meta类的属性名由Django预定义，常用的Meta类属性汇总如下。</p>
<p>● abstract:True or False，标识本类是否为抽象基类。</p>
<p>● app_label：定义本类所属的应用，比如app_label = ‘myapp’。</p>
<p>● db_table：映射的数据表名，比如db_table = ‘moments’。</p>
<p><strong>技巧：</strong>
如果Meta中不提供db_table字段，则Django会为模型自动生成数据表名，生成的格式为“应用名_模型名”，比如应用app的模型Comment的默认数据表名为app_comment。</p>
<p>●
db_tablespace：映射的表空间名称。表空间的概念只在某些数据库如Oracle中存在，不存在表空间概念的数据库将忽略本字段。</p>
<p>●
default_related_name：定义本模型的反向关系引用名称，默认与模型名一致。本名称的含义将在后续的内容中说明。</p>
<p>●
get_latest_by：定义按哪个字段值排列以获得模型的开始或结束记录，本属性值通常指向一个日期或整型的模型字段。</p>
<p>● managed:True or
False，定义Django的manage.py命令行工具是否管理本模型。本属性默认为True，如果将其设为False，则运行python
manage.py
migrate时将不会在数据库中生成本模型的数据表，所以需要手工维护数据库的定义。</p>
<p>● order_with_respect_to：定义本模型可以按照某外键引用的关系排序。</p>
<p>●
ordering：本模型记录的默认排序字段，可以设置多个字段，默认以降序排列，如果以升序排列则需要在字段名前加“负号”。比如如下定义按user_name升序和pub_date降序排列。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
  <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_name&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_date&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>● default_permissions：模型操作权限，默认为default_permisstions=
（’add’, ‘change’, ‘delete’）。</p>
<p>● proxy:True or Flase，本模型及所有继承自本模型的子模型是否为代理模型。</p>
<p>●
required_db_features：定义底层数据库所必须具备的特性。比如required_db_features=[‘gis_enabled’]只将本数据模型生成在满足gis_enabled特性的数据库中。</p>
<p>●
required_db_vendor：定义底层数据库的类型，比如SQLite、PostgreSQL、MySQL、Oracle。如果定义了本属性，则模型只能在其声明的数据库中被维护。</p>
<p>●
unique_together：用来设置的不重复的字段组合，必须唯一（可以将多个字段做联合唯一）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
  <span class="n">unique_together</span> <span class="o">=</span><span class="p">(</span> <span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="s2">&quot;pub_date&quot;</span><span class="p">),</span> <span class="p">)</span>
</pre></div>
</div>
<p>上述代码定义每个user_name在同一个pub_date中只能有一条数据表记录。因为unique_together本身是一个元组，所以可以设置多个这样的唯一约束。</p>
<p>● index_together：定义联合索引的字段，可以设置多个。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
  <span class="n">index_together</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;pub_date&quot;</span><span class="p">,</span> <span class="s2">&quot;deadline&quot;</span><span class="p">],</span> <span class="p">]</span>
</pre></div>
</div>
<p>●
verbose_name：指明一个易于理解和表述的单数形式的对象名称。如果这个值没有被设置，则Django将会使用该model的类名的分词形式作为它的对象表述名，即CamelCase将会被转换为camel
case。</p>
<p>● verbose_name_plural：指明一个易于理解和表述的复数形式的对象名称。</p>
<p><strong>2．普通字段类型</strong></p>
<p>普通字段是指模型类中除外键关系外的数据字段属性。数据字段为Django使用模型时提供如下信息。</p>
<p>● 在数据库中用什么类型定义模型字段，比如INTEGER、VARCHAR等。</p>
<p>● 用什么样的HTML标签显示模型字段，比如<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;radio&quot;&gt;</span></code>等。</p>
<p>● 需要什么样的HTML表单数据验证。</p>
<p>所有数据字段的属性必须继承自抽象类django.db.models.Field，开发者可以定义自己的继承自该类的字段类型，也可以使用Django预定义的一系列Field子类。常用的Django预定义字段类型描述如下。</p>
<p>●
AutoField：一个自动递增的整型字段，添加记录时它会自动增长。AutoField字段通常只用于充当数据表的主键；如果在模型中没有指定主键字段，则Django会自动添加一个AutoField字段。</p>
<p>● BigIntegerField:64位整型字段。</p>
<p>● BinaryField：二进制数据字段，只能通过bytes对其进行赋值。</p>
<p>●
BooleanField：布尔字段，相对应的HTML标签是<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;checkbox&quot;&gt;</span></code>。</p>
<p>●
CharField：字符串字段，用于较短的字符串，相对应的HTML标签是单行输入框<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;&gt;</span></code>。</p>
<p>●
TextField：大容量文本字段，相对应的HTML标签是多行编辑框<code class="docutils literal notranslate"><span class="pre">&lt;textarea&gt;</span></code>。</p>
<p>●
CommaSeparatedIntegerField：用于存放逗号分隔的整数值，相对于普通的CharField，它有特殊的表单数据验证要求。</p>
<p>●
DateField：日期字段，相对应的HTML标签是<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;&gt;</span></code>、一个JavaScript日历和一个“Today”快捷按键。有下列额外的可选参数：auto_now，当对象被保存时，将该字段的值设置为当前时间；auto_now_add，当对象首次被创建时，将该字段的值设置为当前时间。</p>
<p>● DateTimeField：类似于DateField，但同时支持于时间的输入。</p>
<p>● DurationField：存储时间周期，用Python的timedelta类型构建。</p>
<p>● EmailField：一个带有检查Email合法性的CharField。</p>
<p>●
FileField：一个文件上传字段。在定义本子段时必须传入参数upload_to，用于保存上载文件的服务器文件系统的路径。这个路径必须包含strftime
formatting，该格式将被上载文件的date/time替换。</p>
<p>●
FilePathField：按目录限制规则选择文件，定义本字段时必须传入参数path，用以限定目录。</p>
<p>●
FloatField：浮点型字段。定义本字段时必须传入参数max_digits和decimal_places，用于定义总位数（不包括小数点和符号）和小数位数。</p>
<p>●
ImageField：类似于FileField，同时验证上传对象是否是一个合法图片。它有两个可选参数，即height_field和width_field，如果提供这两个参数，则图片将按提供的高度和宽度规格保存。该字段要求安装Python
Imaging库。</p>
<p>● IntegerField：用于保存一个整数。</p>
<p>● IPAddressField：一个字符串形式的IP地址，比如“129.23.250.2”。</p>
<p>● NullBooleanField：类似于BooleanField，但比其多一个None选项。</p>
<p>●
PhoneNumberField：带有美国风格的电话号码校验的CharField（格式为XXX-XXX-XXXX）。</p>
<p>● PositiveIntegerField：只能输入非负数的IntegerField。</p>
<p>● SlugField：只包含字母、数字、下画线和连字符的输入字段，它通常用于URL。</p>
<p>●
SmallIntegerField：类似于IntegerField，但只具有较小的输入范围，具体范围依赖于所使用的数据库。</p>
<p>● TimeField：时间字段，类似于DateTimeField，但只能表达和输入时间。</p>
<p>● URLField：用于保存URL。</p>
<p>● USStateField：美国州名的缩写字段，由两个字母组成。</p>
<p>● XMLField:XML字符字段，是具有XML合法性验证的TextField。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="01.客户端的编程技术.html" class="btn btn-neutral float-right" title="22.6.2. 客户端的编程技术" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="22.6. Python高效开发实战-Django、Flask" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, huxiaojian

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>